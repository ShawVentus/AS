# 数据模型重构计划：分离公共元数据与个性化状态

## 1. 目标
重构 [backend/app/schemas/paper.py](file:///Users/mac/Desktop/AS/backend/app/schemas/paper.py) 及相关数据库结构，以明确区分**论文公共元数据**（所有用户共享）和**用户个性化数据**（每个用户独有）。

## 2. 模型设计 (Schema)

我们将数据拆分为三个核心模型：

### 2.1 `PaperMetadata` (公共元数据)
对应数据库 [papers](file:///Users/mac/Desktop/AS/backend/app/api/v1/endpoints/papers.py#13-16) 表。存储论文的客观事实（爬虫获取）和通用的 AI 分析结果。

```python
class PaperMetadata(BaseModel):
    # --- 基础信息 (Stage 1: Crawler) ---
    id: str
    title: str
    authors: List[str]
    published_date: str
    category: List[str]
    abstract: str  # [MOVED] 移至基础信息，因为是爬虫获取的原始内容
    links: PaperLinks
    comment: Optional[str] = None # 备注，如获奖信息

    # --- 通用分析 (Stage 2: AI Analysis) ---
    # 这些是 AI 对论文内容的客观总结，不针对特定用户
    tldr: Optional[str] = None
    tags: List[str] = [] # 通用标签 (AI 提取)
    
    # 深度分析字段 (AI 生成)
    motivation: Optional[str] = None
    method: Optional[str] = None
    result: Optional[str] = None
    conclusion: Optional[str] = None
```

### 2.2 `UserPaperState` (个性化状态)
对应数据库新增的 `user_paper_states` 表。存储用户与论文的交互状态。

```python
class UserPaperState(BaseModel):
    paper_id: str
    user_id: str
    
    # --- 推荐引擎生成 (LLM) ---
    relevance_score: float = 0.0 # 0.0 ~ 1.0
    why_this_paper: Optional[str] = None # 针对该用户的推荐理由
    accepted: bool = False # [NEW] LLM 结合用户画像给出的“是否接受”建议 (用于预判)
    
    # --- 用户交互状态 (User Action) ---
    user_accepted: bool = False # [RENAMED] 用户最终决定是否"接受" (生成报告用，初始值可默认等于 accepted)
    user_liked: Optional[bool] = None # [RENAMED] Like (True) / Dislike (False) / None
    user_feedback: Optional[str] = None # [RENAMED] 用户反馈的具体原因
    # user_tags 已移除
```

### 2.3 `PersonalizedPaper` (API 响应模型)
前端展示用的组合模型，包含所有信息。

```python
class PersonalizedPaper(PaperMetadata):
    # 组合个性化状态，前端可直接访问所有字段
    user_state: UserPaperState
```

## 3. 前端展示映射

### 3.1 外部卡片 (List View)
展示精简信息，吸引用户点击。
-   **数据源**: `PersonalizedPaper`
-   **展示字段**:
    -   `title`, `authors`, `published_date`, `category` (基础信息)
    -   [tags](file:///Users/mac/Desktop/AS/backend/app/schemas/paper.py#35-41) (通用标签)
    -   `user_state.why_this_paper` (个性化推荐理由)
    -   `user_state.relevance_score` (相关度)
    -   `user_state.accepted` (LLM 推荐标签)

### 3.2 独立卡片/详情页 (Detail View)
展示完整深度信息。
-   **数据源**: `PersonalizedPaper`
-   **额外展示字段**:
    -   `tldr` (一句话总结)
    -   `abstract` (原始摘要)
    -   `motivation`, `method`, `result`, `conclusion` (深度分析)
    -   `links` (PDF/Arxiv/HTML)
-   **交互功能**:
    -   Accept/Reject (`user_state.user_accepted`)
    -   Like/Dislike (`user_state.user_liked`) + Reason (`user_state.user_feedback`)

## 4. 数据库变更计划

### 新增 `user_paper_states` 表
```sql
create table if not exists user_paper_states (
    user_id text references users(id),
    paper_id text references papers(id),
    relevance_score float,
    why_this_paper text,
    accepted boolean default false, -- LLM 建议
    user_accepted boolean default false, -- 用户决定
    user_liked boolean, -- 用户喜好
    user_feedback text, -- 用户反馈
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    primary key (user_id, paper_id)
);
```

### 修改 [papers](file:///Users/mac/Desktop/AS/backend/app/api/v1/endpoints/papers.py#13-16) 表 (如有必要)
-   确保 `abstract` 字段存在且非空。
-   将 `details` JSONB 字段拆分或规范化为 `motivation`, `method` 等列（可选，或继续保持 JSONB 但在代码层映射）。建议保持 JSONB `details` 存储深度分析字段，但 `abstract` 独立出来。
