name: Daily ArxivScout Report

on:
  schedule:
    - cron: "0 7 * * *" # UTC 03:00 = åŒ—äº¬æ—¶é—´ 11:00
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

concurrency:
  group: daily-report
  cancel-in-progress: false

jobs:
  daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: "main" # ä¿®æ”¹ä¸º main åˆ†æ”¯

      - name: è®¾ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ===== pip ç¼“å­˜åŠ é€Ÿ =====
      - name: ç¼“å­˜ pip ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          cd backend
          pip install -r requirements.txt

      - name: æ‰§è¡Œæ¯æ—¥å·¥ä½œæµ
        env:
          # ğŸ” æ•æ„Ÿé…ç½® (ä½¿ç”¨ Secrets)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BOHRIUM_API_KEY: ${{ secrets.BOHRIUM_API_KEY }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          ADMIN_EMAILS: ${{ secrets.ADMIN_EMAILS }}

          # âš™ï¸ æ™®é€šé…ç½® (ä½¿ç”¨ Variables)
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER }}
          MODEL_CHEAP: ${{ vars.MODEL_CHEAP }}
          MODEL_PERFORMANCE: ${{ vars.MODEL_PERFORMANCE }}
          LLM_ANALYSIS_BATCH_SIZE: ${{ vars.LLM_ANALYSIS_BATCH_SIZE }}
          LLM_ANALYSIS_BATCH_DELAY: ${{ vars.LLM_ANALYSIS_BATCH_DELAY }}
          LLM_MAX_WORKERS: ${{ vars.LLM_MAX_WORKERS }}
          SMTP_SERVER: ${{ vars.SMTP_SERVER }}
          SMTP_PORT: ${{ vars.SMTP_PORT }}
          SENDER_EMAIL: ${{ vars.SENDER_EMAIL }}
          SENDER_NAME: ${{ vars.SENDER_NAME }} # æ–°å¢ï¼šå‘ä»¶äººåç§°
          SMTP_TIMEOUT: ${{ vars.SMTP_TIMEOUT }} # æ–°å¢ï¼šSMTP è¶…æ—¶æ—¶é—´
          BATCH_EMAIL_DELAY: ${{ vars.BATCH_EMAIL_DELAY }} # æ–°å¢ï¼šæ‰¹é‡å‘é€å»¶è¿Ÿ
          ARXIV_DELAY_SECONDS: ${{ vars.ARXIV_DELAY_SECONDS }}
          ARXIV_NUM_RETRIES: ${{ vars.ARXIV_NUM_RETRIES }}
          REPORT_PAPER_LIMIT: ${{ vars.REPORT_PAPER_LIMIT }}
          WORKFLOW_MAX_RETRIES: ${{ vars.WORKFLOW_MAX_RETRIES }}
          WORKFLOW_RETRY_DELAY_BASE: ${{ vars.WORKFLOW_RETRY_DELAY_BASE }}
        run: |
          cd backend
          # æ‰§è¡Œæ¯æ—¥å·¥ä½œæµè„šæœ¬
          python3 -c "from app.services.scheduler import scheduler_service; scheduler_service.run_daily_workflow(force=True)"

      # ===== æ—¥å¿—æ–‡ä»¶ä¸Šä¼  =====
      - name: ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
        uses: actions/upload-artifact@v4
        if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ 
        with:
          name: workflow-logs-${{ github.run_id }}
          path: backend/logs/
          retention-days: 30 # ä¿ç•™ 30 å¤©
